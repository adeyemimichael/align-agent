module.exports=[38372,e=>{"use strict";($=J||(J={})).STRING="string",$.NUMBER="number",$.INTEGER="integer",$.BOOLEAN="boolean",$.ARRAY="array",$.OBJECT="object",(U=W||(W={})).LANGUAGE_UNSPECIFIED="language_unspecified",U.PYTHON="python",(H=X||(X={})).OUTCOME_UNSPECIFIED="outcome_unspecified",H.OUTCOME_OK="outcome_ok",H.OUTCOME_FAILED="outcome_failed",H.OUTCOME_DEADLINE_EXCEEDED="outcome_deadline_exceeded";let t=["user","model","function","system"];(L=z||(z={})).HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",L.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",L.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",L.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",L.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT",L.HARM_CATEGORY_CIVIC_INTEGRITY="HARM_CATEGORY_CIVIC_INTEGRITY",(F=Q||(Q={})).HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",F.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",F.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",F.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",F.BLOCK_NONE="BLOCK_NONE",(j=Z||(Z={})).HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",j.NEGLIGIBLE="NEGLIGIBLE",j.LOW="LOW",j.MEDIUM="MEDIUM",j.HIGH="HIGH",(G=ee||(ee={})).BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",G.SAFETY="SAFETY",G.OTHER="OTHER",(K=et||(et={})).FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",K.STOP="STOP",K.MAX_TOKENS="MAX_TOKENS",K.SAFETY="SAFETY",K.RECITATION="RECITATION",K.LANGUAGE="LANGUAGE",K.BLOCKLIST="BLOCKLIST",K.PROHIBITED_CONTENT="PROHIBITED_CONTENT",K.SPII="SPII",K.MALFORMED_FUNCTION_CALL="MALFORMED_FUNCTION_CALL",K.OTHER="OTHER",(B=en||(en={})).TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",B.RETRIEVAL_QUERY="RETRIEVAL_QUERY",B.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",B.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",B.CLASSIFICATION="CLASSIFICATION",B.CLUSTERING="CLUSTERING",(q=es||(es={})).MODE_UNSPECIFIED="MODE_UNSPECIFIED",q.AUTO="AUTO",q.ANY="ANY",q.NONE="NONE",(Y=ea||(ea={})).MODE_UNSPECIFIED="MODE_UNSPECIFIED",Y.MODE_DYNAMIC="MODE_DYNAMIC";class n extends Error{constructor(e){super(`[GoogleGenerativeAI Error]: ${e}`)}}class s extends n{constructor(e,t){super(e),this.response=t}}class a extends n{constructor(e,t,n,s){super(e),this.status=t,this.statusText=n,this.errorDetails=s}}class i extends n{}class o extends n{}(V=ei||(ei={})).GENERATE_CONTENT="generateContent",V.STREAM_GENERATE_CONTENT="streamGenerateContent",V.COUNT_TOKENS="countTokens",V.EMBED_CONTENT="embedContent",V.BATCH_EMBED_CONTENTS="batchEmbedContents";class r{constructor(e,t,n,s,a){this.model=e,this.task=t,this.apiKey=n,this.stream=s,this.requestOptions=a}toString(){var e,t;let n=(null==(e=this.requestOptions)?void 0:e.apiVersion)||"v1beta",s=(null==(t=this.requestOptions)?void 0:t.baseUrl)||"https://generativelanguage.googleapis.com",a=`${s}/${n}/${this.model}:${this.task}`;return this.stream&&(a+="?alt=sse"),a}}async function l(e){var t,n;let s,a=new Headers;a.append("Content-Type","application/json"),a.append("x-goog-api-client",(n=e.requestOptions,s=[],(null==n?void 0:n.apiClient)&&s.push(n.apiClient),s.push("genai-js/0.24.1"),s.join(" "))),a.append("x-goog-api-key",e.apiKey);let o=null==(t=e.requestOptions)?void 0:t.customHeaders;if(o){if(!(o instanceof Headers))try{o=new Headers(o)}catch(e){throw new i(`unable to convert customHeaders value ${JSON.stringify(o)} to Headers: ${e.message}`)}for(let[e,t]of o.entries()){if("x-goog-api-key"===e)throw new i(`Cannot set reserved header name ${e}`);if("x-goog-api-client"===e)throw new i(`Header name ${e} can only be set using the apiClient field`);a.append(e,t)}}return a}async function d(e,t,n,s,a,i){let o=new r(e,t,n,s,i);return{url:o.toString(),fetchOptions:Object.assign(Object.assign({},function(e){let t={};if((null==e?void 0:e.signal)!==void 0||(null==e?void 0:e.timeout)>=0){let n=new AbortController;(null==e?void 0:e.timeout)>=0&&setTimeout(()=>n.abort(),e.timeout),(null==e?void 0:e.signal)&&e.signal.addEventListener("abort",()=>{n.abort()}),t.signal=n.signal}return t}(i)),{method:"POST",headers:await l(o),body:a})}}async function c(e,t,n,s,a,i={},o=fetch){let{url:r,fetchOptions:l}=await d(e,t,n,s,a,i);return u(r,l,o)}async function u(e,t,s=fetch){let r;try{r=await s(e,t)}catch(s){var l=s,d=e;let t=l;throw"AbortError"===t.name?(t=new o(`Request aborted when fetching ${d.toString()}: ${l.message}`)).stack=l.stack:l instanceof a||l instanceof i||((t=new n(`Error fetching from ${d.toString()}: ${l.message}`)).stack=l.stack),t}return r.ok||await h(r,e),r}async function h(e,t){let n,s="";try{let t=await e.json();s=t.error.message,t.error.details&&(s+=` ${JSON.stringify(t.error.details)}`,n=t.error.details)}catch(e){}throw new a(`Error fetching from ${t.toString()}: [${e.status} ${e.statusText}] ${s}`,e.status,e.statusText,n)}function p(e){return e.text=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),m(e.candidates[0]))throw new s(`${E(e)}`,e);return function(e){var t,n,s,a;let i=[];if(null==(n=null==(t=e.candidates)?void 0:t[0].content)?void 0:n.parts)for(let t of null==(a=null==(s=e.candidates)?void 0:s[0].content)?void 0:a.parts)t.text&&i.push(t.text),t.executableCode&&i.push("\n```"+t.executableCode.language+"\n"+t.executableCode.code+"\n```\n"),t.codeExecutionResult&&i.push("\n```\n"+t.codeExecutionResult.output+"\n```\n");return i.length>0?i.join(""):""}(e)}if(e.promptFeedback)throw new s(`Text not available. ${E(e)}`,e);return""},e.functionCall=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),m(e.candidates[0]))throw new s(`${E(e)}`,e);return console.warn("response.functionCall() is deprecated. Use response.functionCalls() instead."),g(e)[0]}if(e.promptFeedback)throw new s(`Function call not available. ${E(e)}`,e)},e.functionCalls=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),m(e.candidates[0]))throw new s(`${E(e)}`,e);return g(e)}if(e.promptFeedback)throw new s(`Function call not available. ${E(e)}`,e)},e}function g(e){var t,n,s,a;let i=[];if(null==(n=null==(t=e.candidates)?void 0:t[0].content)?void 0:n.parts)for(let t of null==(a=null==(s=e.candidates)?void 0:s[0].content)?void 0:a.parts)t.functionCall&&i.push(t.functionCall);return i.length>0?i:void 0}let f=[et.RECITATION,et.SAFETY,et.LANGUAGE];function m(e){return!!e.finishReason&&f.includes(e.finishReason)}function E(e){var t,n,s;let a="";if((!e.candidates||0===e.candidates.length)&&e.promptFeedback)a+="Response was blocked",(null==(t=e.promptFeedback)?void 0:t.blockReason)&&(a+=` due to ${e.promptFeedback.blockReason}`),(null==(n=e.promptFeedback)?void 0:n.blockReasonMessage)&&(a+=`: ${e.promptFeedback.blockReasonMessage}`);else if(null==(s=e.candidates)?void 0:s[0]){let t=e.candidates[0];m(t)&&(a+=`Candidate was blocked due to ${t.finishReason}`,t.finishMessage&&(a+=`: ${t.finishMessage}`))}return a}function y(e){return this instanceof y?(this.v=e,this):new y(e)}"function"==typeof SuppressedError&&SuppressedError;let C=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;async function R(e){let t=[],n=e.getReader();for(;;){let{done:e,value:s}=await n.read();if(e)return p(function(e){let t=e[e.length-1],n={promptFeedback:null==t?void 0:t.promptFeedback};for(let t of e){if(t.candidates){let e=0;for(let s of t.candidates)if(n.candidates||(n.candidates=[]),n.candidates[e]||(n.candidates[e]={index:e}),n.candidates[e].citationMetadata=s.citationMetadata,n.candidates[e].groundingMetadata=s.groundingMetadata,n.candidates[e].finishReason=s.finishReason,n.candidates[e].finishMessage=s.finishMessage,n.candidates[e].safetyRatings=s.safetyRatings,s.content&&s.content.parts){n.candidates[e].content||(n.candidates[e].content={role:s.content.role||"user",parts:[]});let t={};for(let a of s.content.parts)a.text&&(t.text=a.text),a.functionCall&&(t.functionCall=a.functionCall),a.executableCode&&(t.executableCode=a.executableCode),a.codeExecutionResult&&(t.codeExecutionResult=a.codeExecutionResult),0===Object.keys(t).length&&(t.text=""),n.candidates[e].content.parts.push(t)}e++}t.usageMetadata&&(n.usageMetadata=t.usageMetadata)}return n}(t));t.push(s)}}async function w(e,t,s,a){return function(e){let t,[s,a]=(t=e.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0})).getReader(),new ReadableStream({start(e){let s="";return function a(){return t.read().then(({value:t,done:i})=>{let o;if(i)return s.trim()?void e.error(new n("Failed to parse stream")):void e.close();let r=(s+=t).match(C);for(;r;){try{o=JSON.parse(r[1])}catch(t){e.error(new n(`Error parsing JSON response: "${r[1]}"`));return}e.enqueue(o),r=(s=s.substring(r[0].length)).match(C)}return a()}).catch(e=>{let t=e;throw t.stack=e.stack,t="AbortError"===t.name?new o("Request aborted when reading from the stream"):new n("Error reading from the stream")})}()}})).tee();return{stream:function(e){return function(e,t,n){if(!Symbol.asyncIterator)throw TypeError("Symbol.asyncIterator is not defined.");var s,a=n.apply(e,t||[]),i=[];return s={},o("next"),o("throw"),o("return"),s[Symbol.asyncIterator]=function(){return this},s;function o(e){a[e]&&(s[e]=function(t){return new Promise(function(n,s){i.push([e,t,n,s])>1||r(e,t)})})}function r(e,t){try{var n;(n=a[e](t)).value instanceof y?Promise.resolve(n.value.v).then(l,d):c(i[0][2],n)}catch(e){c(i[0][3],e)}}function l(e){r("next",e)}function d(e){r("throw",e)}function c(e,t){e(t),i.shift(),i.length&&r(i[0][0],i[0][1])}}(this,arguments,function*(){let t=e.getReader();for(;;){let{value:e,done:n}=yield y(t.read());if(n)break;yield yield y(p(e))}})}(s),response:R(a)}}(await c(t,ei.STREAM_GENERATE_CONTENT,e,!0,JSON.stringify(s),a))}async function O(e,t,n,s){let a=await c(t,ei.GENERATE_CONTENT,e,!1,JSON.stringify(n),s);return{response:p(await a.json())}}function I(e){if(null!=e){if("string"==typeof e)return{role:"system",parts:[{text:e}]};if(e.text)return{role:"system",parts:[e]};if(e.parts)if(!e.role)return{role:"system",parts:e.parts};else return e}}function T(e){let t=[];if("string"==typeof e)t=[{text:e}];else for(let n of e)"string"==typeof n?t.push({text:n}):t.push(n);var s=t;let a={role:"user",parts:[]},i={role:"function",parts:[]},o=!1,r=!1;for(let e of s)"functionResponse"in e?(i.parts.push(e),r=!0):(a.parts.push(e),o=!0);if(o&&r)throw new n("Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.");if(!o&&!r)throw new n("No content is provided for sending chat message.");return o?a:i}function _(e){let t;return t=e.contents?e:{contents:[T(e)]},e.systemInstruction&&(t.systemInstruction=I(e.systemInstruction)),t}let v=["text","inlineData","functionCall","functionResponse","executableCode","codeExecutionResult"],A={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall","executableCode","codeExecutionResult"],system:["text"]};function N(e){var t;if(void 0===e.candidates||0===e.candidates.length)return!1;let n=null==(t=e.candidates[0])?void 0:t.content;if(void 0===n||void 0===n.parts||0===n.parts.length)return!1;for(let e of n.parts)if(void 0===e||0===Object.keys(e).length||void 0!==e.text&&""===e.text)return!1;return!0}let S="SILENT_ERROR";class b{constructor(e,s,a,i={}){this.model=s,this.params=a,this._requestOptions=i,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=e,(null==a?void 0:a.history)&&(!function(e){let s=!1;for(let a of e){let{role:e,parts:i}=a;if(!s&&"user"!==e)throw new n(`First content should be with role 'user', got ${e}`);if(!t.includes(e))throw new n(`Each item should include role field. Got ${e} but valid roles are: ${JSON.stringify(t)}`);if(!Array.isArray(i))throw new n("Content should have 'parts' property with an array of Parts");if(0===i.length)throw new n("Each Content should have at least one part");let o={text:0,inlineData:0,functionCall:0,functionResponse:0,fileData:0,executableCode:0,codeExecutionResult:0};for(let e of i)for(let t of v)t in e&&(o[t]+=1);let r=A[e];for(let t of v)if(!r.includes(t)&&o[t]>0)throw new n(`Content with role '${e}' can't contain '${t}' part`);s=!0}}(a.history),this._history=a.history)}async getHistory(){return await this._sendPromise,this._history}async sendMessage(e,t={}){var n,s,a,i,o,r;let l;await this._sendPromise;let d=T(e),c={safetySettings:null==(n=this.params)?void 0:n.safetySettings,generationConfig:null==(s=this.params)?void 0:s.generationConfig,tools:null==(a=this.params)?void 0:a.tools,toolConfig:null==(i=this.params)?void 0:i.toolConfig,systemInstruction:null==(o=this.params)?void 0:o.systemInstruction,cachedContent:null==(r=this.params)?void 0:r.cachedContent,contents:[...this._history,d]},u=Object.assign(Object.assign({},this._requestOptions),t);return this._sendPromise=this._sendPromise.then(()=>O(this._apiKey,this.model,c,u)).then(e=>{var t;if(N(e.response)){this._history.push(d);let n=Object.assign({parts:[],role:"model"},null==(t=e.response.candidates)?void 0:t[0].content);this._history.push(n)}else{let t=E(e.response);t&&console.warn(`sendMessage() was unsuccessful. ${t}. Inspect response object for details.`)}l=e}).catch(e=>{throw this._sendPromise=Promise.resolve(),e}),await this._sendPromise,l}async sendMessageStream(e,t={}){var n,s,a,i,o,r;await this._sendPromise;let l=T(e),d={safetySettings:null==(n=this.params)?void 0:n.safetySettings,generationConfig:null==(s=this.params)?void 0:s.generationConfig,tools:null==(a=this.params)?void 0:a.tools,toolConfig:null==(i=this.params)?void 0:i.toolConfig,systemInstruction:null==(o=this.params)?void 0:o.systemInstruction,cachedContent:null==(r=this.params)?void 0:r.cachedContent,contents:[...this._history,l]},c=Object.assign(Object.assign({},this._requestOptions),t),u=w(this._apiKey,this.model,d,c);return this._sendPromise=this._sendPromise.then(()=>u).catch(e=>{throw Error(S)}).then(e=>e.response).then(e=>{if(N(e)){this._history.push(l);let t=Object.assign({},e.candidates[0].content);t.role||(t.role="model"),this._history.push(t)}else{let t=E(e);t&&console.warn(`sendMessageStream() was unsuccessful. ${t}. Inspect response object for details.`)}}).catch(e=>{e.message!==S&&console.error(e)}),u}}async function k(e,t,n,s){return(await c(t,ei.COUNT_TOKENS,e,!1,JSON.stringify(n),s)).json()}async function D(e,t,n,s){return(await c(t,ei.EMBED_CONTENT,e,!1,JSON.stringify(n),s)).json()}async function M(e,t,n,s){let a=n.requests.map(e=>Object.assign(Object.assign({},e),{model:t}));return(await c(t,ei.BATCH_EMBED_CONTENTS,e,!1,JSON.stringify({requests:a}),s)).json()}class x{constructor(e,t,n={}){this.apiKey=e,this._requestOptions=n,t.model.includes("/")?this.model=t.model:this.model=`models/${t.model}`,this.generationConfig=t.generationConfig||{},this.safetySettings=t.safetySettings||[],this.tools=t.tools,this.toolConfig=t.toolConfig,this.systemInstruction=I(t.systemInstruction),this.cachedContent=t.cachedContent}async generateContent(e,t={}){var n;let s=_(e),a=Object.assign(Object.assign({},this._requestOptions),t);return O(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:null==(n=this.cachedContent)?void 0:n.name},s),a)}async generateContentStream(e,t={}){var n;let s=_(e),a=Object.assign(Object.assign({},this._requestOptions),t);return w(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:null==(n=this.cachedContent)?void 0:n.name},s),a)}startChat(e){var t;return new b(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:null==(t=this.cachedContent)?void 0:t.name},e),this._requestOptions)}async countTokens(e,t={}){let n=function(e,t){var n;let s={model:null==t?void 0:t.model,generationConfig:null==t?void 0:t.generationConfig,safetySettings:null==t?void 0:t.safetySettings,tools:null==t?void 0:t.tools,toolConfig:null==t?void 0:t.toolConfig,systemInstruction:null==t?void 0:t.systemInstruction,cachedContent:null==(n=null==t?void 0:t.cachedContent)?void 0:n.name,contents:[]},a=null!=e.generateContentRequest;if(e.contents){if(a)throw new i("CountTokensRequest must have one of contents or generateContentRequest, not both.");s.contents=e.contents}else if(a)s=Object.assign(Object.assign({},s),e.generateContentRequest);else{let t=T(e);s.contents=[t]}return{generateContentRequest:s}}(e,{model:this.model,generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction,cachedContent:this.cachedContent}),s=Object.assign(Object.assign({},this._requestOptions),t);return k(this.apiKey,this.model,n,s)}async embedContent(e,t={}){let n="string"==typeof e||Array.isArray(e)?{content:T(e)}:e,s=Object.assign(Object.assign({},this._requestOptions),t);return D(this.apiKey,this.model,n,s)}async batchEmbedContents(e,t={}){let n=Object.assign(Object.assign({},this._requestOptions),t);return M(this.apiKey,this.model,e,n)}}class P{constructor(e){this.apiKey=e}getGenerativeModel(e,t){if(!e.model)throw new n("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new x(this.apiKey,e,t)}getGenerativeModelFromCachedContent(e,t,n){if(!e.name)throw new i("Cached content must contain a `name` field.");if(!e.model)throw new i("Cached content must contain a `model` field.");for(let n of["model","systemInstruction"])if((null==t?void 0:t[n])&&e[n]&&(null==t?void 0:t[n])!==e[n]){if("model"===n&&(t.model.startsWith("models/")?t.model.replace("models/",""):t.model)===(e.model.startsWith("models/")?e.model.replace("models/",""):e.model))continue;throw new i(`Different value for "${n}" specified in modelParams (${t[n]}) and cachedContent (${e[n]})`)}let s=Object.assign(Object.assign({},t),{model:e.model,tools:e.tools,toolConfig:e.toolConfig,systemInstruction:e.systemInstruction,cachedContent:e});return new x(this.apiKey,s,n)}}var $,U,H,L,F,j,G,K,B,q,Y,V,J,W,X,z,Q,Z,ee,et,en,es,ea,ei,eo=e.i(49566);class er{genAI;model;constructor(e){const t=e||process.env.GEMINI_API_KEY;if(!t)throw Error("GEMINI_API_KEY not configured");this.genAI=new P(t),this.model=this.genAI.getGenerativeModel({model:"gemini-pro"})}async generateDailyPlan(e,t=new Date,n){let s=this.buildPlanningPrompt(e,t),a=Date.now();try{let i=await this.model.generateContent(s),o=(await i.response).text(),r=Date.now()-a,l=this.parsePlanningResponse(o,e.tasks,t);return n&&(await (0,eo.logAIRequest)({userId:n,capacityScore:e.capacityScore,mode:e.mode,taskCount:e.tasks.length,prompt:s,response:o,reasoning:l.overallReasoning,duration:r,timestamp:new Date}).catch(e=>console.error("Opik logging failed:",e)),await (0,eo.trackReasoningQuality)({userId:n,reasoning:l.overallReasoning,taskCount:e.tasks.length}).catch(e=>console.error("Opik reasoning tracking failed:",e))),l}catch(e){throw console.error("Gemini AI error:",e),Error(`Failed to generate plan: ${e instanceof Error?e.message:"Unknown error"}`)}}buildPlanningPrompt(e,t){let{capacityScore:n,mode:s,tasks:a,history:i,goals:o}=e,r=i.map(e=>`- ${e.date.toLocaleDateString()}: Capacity ${e.capacityScore.toFixed(0)}, Completed ${e.completedTasks}/${e.totalTasks} tasks`).join("\n"),l=a.map(e=>`- [${e.id}] ${e.title} (Priority: ${e.priority}, Est: ${e.estimatedMinutes}min${e.dueDate?`, Due: ${e.dueDate.toLocaleDateString()}`:""})`).join("\n"),d=o?o.map(e=>`- ${e.title} (${e.category})`).join("\n"):"No goals set";return`You are an AI productivity assistant helping a user plan their day based on their current capacity and goals.

**Current Context:**
- Date: ${t.toLocaleDateString()}
- Time: ${t.toLocaleTimeString()}
- Capacity Score: ${n.toFixed(0)}/100
- Mode: ${s.toUpperCase()}

**Mode Guidelines:**
- RECOVERY (score < 40): Prioritize rest, light tasks, and self-care. Limit work to 2-3 hours max.
- BALANCED (score 40-69): Mix of focused work and breaks. Standard 4-6 hour workday.
- DEEP_WORK (score â‰¥ 70): Tackle demanding tasks. Can handle 6-8 hours of focused work.

**Recent History (Last 7 Days):**
${r||"No history available"}

**User's Goals:**
${d}

**Available Tasks:**
${l}

**Instructions:**
1. Analyze the user's capacity score and recent patterns
2. Consider their goals and how today's work contributes to them
3. Prioritize tasks based on:
   - Current capacity and mode
   - Task priority and due dates
   - Recent completion patterns
   - Goal alignment
4. Schedule tasks with realistic time blocks
5. Include breaks and recovery time based on capacity
6. Provide clear reasoning for your decisions

**Output Format (JSON):**
{
  "overallReasoning": "Brief explanation of your planning strategy for today",
  "modeRecommendation": "Any suggestions about the current mode or capacity",
  "tasks": [
    {
      "taskId": "task-id",
      "startTime": "HH:MM",
      "duration": minutes,
      "reasoning": "Why this task at this time"
    }
  ]
}

Generate the plan now:`}parsePlanningResponse(e,t,n){try{let s=e.match(/\{[\s\S]*\}/);if(!s)throw Error("No JSON found in response");let a=JSON.parse(s[0]);return{orderedTasks:a.tasks.map(e=>{if(!t.find(t=>t.id===e.taskId))throw Error(`Task ${e.taskId} not found`);let[s,a]=e.startTime.split(":").map(Number),i=new Date(n);i.setHours(s,a,0,0);let o=new Date(i);return o.setMinutes(o.getMinutes()+e.duration),{taskId:e.taskId,scheduledStart:i,scheduledEnd:o,reasoning:e.reasoning}}),overallReasoning:a.overallReasoning,modeRecommendation:a.modeRecommendation}}catch(s){return console.error("Failed to parse Gemini response:",s),console.error("Raw response:",e),this.fallbackPlanning(t,n)}}fallbackPlanning(e,t){console.warn("Using fallback planning due to AI parsing error");let n=[...e].sort((e,t)=>e.priority!==t.priority?e.priority-t.priority:e.dueDate&&t.dueDate?e.dueDate.getTime()-t.dueDate.getTime():e.dueDate?-1:+!!t.dueDate),s=new Date(t);return{orderedTasks:n.map(e=>{let t=new Date(s),n=new Date(s);return n.setMinutes(n.getMinutes()+e.estimatedMinutes),(s=new Date(n)).setMinutes(s.getMinutes()+15),{taskId:e.id,scheduledStart:t,scheduledEnd:n,reasoning:`Priority ${e.priority} task${e.dueDate?" with upcoming due date":""}`}}),overallReasoning:"Using simple priority-based scheduling (AI planning temporarily unavailable)",modeRecommendation:void 0}}async getCapacityInsights(e,t){let n=t.map(e=>`${e.date.toLocaleDateString()}: ${e.capacityScore.toFixed(0)}`).join(", "),s=`Analyze this user's capacity trend and provide brief insights:

Current capacity score: ${e.toFixed(0)}/100
Recent history: ${n}

Provide 2-3 sentences of insight about their capacity trend and any recommendations.`;try{let e=await this.model.generateContent(s);return(await e.response).text()}catch(e){return console.error("Gemini insights error:",e),"Unable to generate insights at this time."}}}let el=null;function ed(){return el||(el=new er),el}e.s(["getGeminiClient",()=>ed],38372)},45718,e=>e.a(async(t,n)=>{try{var s=e.i(51520),a=e.i(18368),i=e.i(72748),o=e.i(38372),r=e.i(65807),l=t([a,i,r]);async function d(e){try{let t,n=await (0,a.auth)();if(!n||!n.user?.email)return s.NextResponse.json({error:"Unauthorized"},{status:401});let{date:l,syncToCalendar:d=!1}=await e.json(),c=await i.prisma.user.findUnique({where:{email:n.user.email}});if(!c)return s.NextResponse.json({error:"User not found"},{status:404});let u=l?new Date(l):new Date;u.setHours(0,0,0,0);let h=await i.prisma.checkIn.findFirst({where:{userId:c.id,date:{gte:u,lt:new Date(u.getTime()+864e5)}},orderBy:{date:"desc"}});if(!h)return s.NextResponse.json({error:"No check-in found for today. Please complete your check-in first."},{status:400});let p=new Date(u);p.setDate(p.getDate()-7);let g=await i.prisma.checkIn.findMany({where:{userId:c.id,date:{gte:p,lt:u}},orderBy:{date:"desc"},take:7}),f=await i.prisma.goal.findMany({where:{userId:c.id},select:{title:!0,category:!0}}),m=await i.prisma.integration.findUnique({where:{userId_platform:{userId:c.id,platform:"todoist"}}}),E=[];if(m){let t=await fetch(`${e.nextUrl.origin}/api/integrations/todoist/tasks`,{headers:{Cookie:e.headers.get("cookie")||""}});t.ok&&(E=(await t.json()).tasks.map(e=>({id:e.id,title:e.content,description:e.description,priority:e.priority,estimatedMinutes:e.estimatedMinutes||45,dueDate:e.due?.date?new Date(e.due.date):void 0,project:e.project_id})))}if(0===E.length){let e=await i.prisma.dailyPlan.findFirst({where:{userId:c.id,date:u},include:{tasks:!0}});e&&(E=e.tasks.map(e=>({id:e.id,title:e.title,description:e.description||void 0,priority:e.priority,estimatedMinutes:e.estimatedMinutes})))}if(0===E.length)return s.NextResponse.json({error:"No tasks available. Please connect Todoist or add tasks manually."},{status:400});let y={capacityScore:h.capacityScore,mode:h.mode,tasks:E,history:g.map(e=>({date:e.date,capacityScore:e.capacityScore,completedTasks:0,totalTasks:0})),goals:f.length>0?f:void 0},C=(0,o.getGeminiClient)(),R=await C.generateDailyPlan(y,new Date,c.id),w=await i.prisma.dailyPlan.create({data:{userId:c.id,date:u,capacityScore:h.capacityScore,mode:h.mode,geminiReasoning:R.overallReasoning,tasks:{create:R.orderedTasks.map(e=>{let t=E.find(t=>t.id===e.taskId);return{externalId:e.taskId,title:t?.title||"Unknown Task",description:t?.description,priority:t?.priority||3,estimatedMinutes:t?.estimatedMinutes||45,scheduledStart:e.scheduledStart,scheduledEnd:e.scheduledEnd}})}},include:{tasks:!0}});if(d){let e=w.tasks.map(e=>({taskId:e.id,title:e.title,description:e.description||void 0,startTime:e.scheduledStart,endTime:e.scheduledEnd,priority:e.priority}));t=await (0,r.syncPlanToCalendar)(c.id,e,Intl.DateTimeFormat().resolvedOptions().timeZone)}return s.NextResponse.json({message:"Daily plan generated successfully",plan:{id:w.id,date:w.date,capacityScore:w.capacityScore,mode:w.mode,reasoning:w.geminiReasoning,modeRecommendation:R.modeRecommendation,tasks:w.tasks.map(e=>({id:e.id,title:e.title,description:e.description,priority:e.priority,estimatedMinutes:e.estimatedMinutes,scheduledStart:e.scheduledStart,scheduledEnd:e.scheduledEnd,completed:e.completed}))},calendarSync:t},{status:201})}catch(e){return console.error("Plan generation error:",e),s.NextResponse.json({error:"Failed to generate plan",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}[a,i,r]=l.then?(await l)():l,e.s(["POST",()=>d]),n()}catch(e){n(e)}},!1),63732,e=>e.a(async(t,n)=>{try{var s=e.i(43712),a=e.i(60108),i=e.i(31393),o=e.i(72321),r=e.i(1958),l=e.i(84172),d=e.i(30910),c=e.i(46820),u=e.i(49088),h=e.i(2500),p=e.i(37143),g=e.i(46153),f=e.i(69714),m=e.i(87675),E=e.i(2964),y=e.i(93695);e.i(471);var C=e.i(54858),R=e.i(45718),w=t([R]);[R]=w.then?(await w)():w;let T=new s.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/plan/generate/route",pathname:"/api/plan/generate",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/align/app/api/plan/generate/route.ts",nextConfigOutput:"",userland:R}),{workAsyncStorage:_,workUnitAsyncStorage:v,serverHooks:A}=T;function O(){return(0,i.patchFetch)({workAsyncStorage:_,workUnitAsyncStorage:v})}async function I(e,t,n){T.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let s="/api/plan/generate/route";s=s.replace(/\/index$/,"")||"/";let i=await T.prepare(e,t,{srcPage:s,multiZoneDraftMode:!1});if(!i)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:R,params:w,nextConfig:O,parsedUrl:I,isDraftMode:_,prerenderManifest:v,routerServerContext:A,isOnDemandRevalidate:N,revalidateOnlyGenerated:S,resolvedPathname:b,clientReferenceManifest:k,serverActionsManifest:D}=i,M=(0,d.normalizeAppPath)(s),x=!!(v.dynamicRoutes[M]||v.routes[b]),P=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,I,!1):t.end("This page could not be found"),null);if(x&&!_){let e=!!v.routes[b],t=v.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(O.experimental.adapterPath)return await P();throw new y.NoFallbackError}}let $=null;!x||T.isDev||_||($=b,$="/index"===$?"/":$);let U=!0===T.isDev||!x,H=x&&!U;D&&k&&(0,l.setManifestsSingleton)({page:s,clientReferenceManifest:k,serverActionsManifest:D});let L=e.method||"GET",F=(0,r.getTracer)(),j=F.getActiveScopeSpan(),G={params:w,prerenderManifest:v,renderOpts:{experimental:{authInterrupts:!!O.experimental.authInterrupts},cacheComponents:!!O.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:O.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,s,a)=>T.onRequestError(e,t,s,a,A)},sharedContext:{buildId:R}},K=new c.NodeNextRequest(e),B=new c.NodeNextResponse(t),q=u.NextRequestAdapter.fromNodeNextRequest(K,(0,u.signalFromNodeResponse)(t));try{let i=async e=>T.handle(q,G).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=F.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==h.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=n.get("next.route");if(a){let t=`${L} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${L} ${s}`)}),l=!!(0,o.getRequestMeta)(e,"minimalMode"),d=async o=>{var r,d;let c=async({previousCacheEntry:a})=>{try{if(!l&&N&&S&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await i(o);e.fetchMetrics=G.renderOpts.fetchMetrics;let r=G.renderOpts.pendingWaitUntil;r&&n.waitUntil&&(n.waitUntil(r),r=void 0);let d=G.renderOpts.collectedTags;if(!x)return await (0,g.sendResponse)(K,B,s,G.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(s.headers);d&&(t[E.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==G.renderOpts.collectedRevalidate&&!(G.renderOpts.collectedRevalidate>=E.INFINITE_CACHE)&&G.renderOpts.collectedRevalidate,a=void 0===G.renderOpts.collectedExpire||G.renderOpts.collectedExpire>=E.INFINITE_CACHE?void 0:G.renderOpts.collectedExpire;return{value:{kind:C.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:a}}}}catch(t){throw(null==a?void 0:a.isStale)&&await T.onRequestError(e,t,{routerKind:"App Router",routePath:s,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:N})},!1,A),t}},u=await T.handleResponse({req:e,nextConfig:O,cacheKey:$,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:v,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:S,responseGenerator:c,waitUntil:n.waitUntil,isMinimalMode:l});if(!x)return null;if((null==u||null==(r=u.value)?void 0:r.kind)!==C.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",N?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),_&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let h=(0,f.fromNodeOutgoingHttpHeaders)(u.value.headers);return l&&x||h.delete(E.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||h.get("Cache-Control")||h.set("Cache-Control",(0,m.getCacheControlHeader)(u.cacheControl)),await (0,g.sendResponse)(K,B,new Response(u.value.body,{headers:h,status:u.value.status||200})),null};j?await d(j):await F.withPropagatedContext(e.headers,()=>F.trace(h.BaseServerSpan.handleRequest,{spanName:`${L} ${s}`,kind:r.SpanKind.SERVER,attributes:{"http.method":L,"http.target":e.url}},d))}catch(t){if(t instanceof y.NoFallbackError||await T.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:N})},!1,A),x)throw t;return await (0,g.sendResponse)(K,B,new Response(null,{status:500})),null}}e.s(["handler",()=>I,"patchFetch",()=>O,"routeModule",()=>T,"serverHooks",()=>A,"workAsyncStorage",()=>_,"workUnitAsyncStorage",()=>v]),n()}catch(e){n(e)}},!1)];

//# sourceMappingURL=align_a123d41f._.js.map